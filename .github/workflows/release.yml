name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: ä¸‹è½½æ¨¡å‹
      run: |
        python download_models.py
      continue-on-error: true  # æ¨¡å‹ä¸‹è½½å¤±è´¥ä¸å½±å“æ‰“åŒ…
    
    - name: æ‰“åŒ…ç¨‹åº
      run: |
        python build_exe.py
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: åˆ›å»º Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: MEMEFinder ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        body: |
          ## ğŸ‰ MEMEFinder ${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½
          
          **Windows ç”¨æˆ·ï¼ˆæ¨èï¼‰**:
          - ä¸‹è½½ `MEMEFinder-${{ steps.get_version.outputs.VERSION }}-Windows-x64.zip`
          - è§£å‹åè¿è¡Œ `ä¸‹è½½æ¨¡å‹.bat`ï¼ˆé¦–æ¬¡å¿…é¡»ï¼‰
          - ç„¶åè¿è¡Œ `MEMEFinder.exe`
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
          2. åŒå‡»è¿è¡Œ `ä¸‹è½½æ¨¡å‹.bat`ï¼ˆä¸‹è½½ AI æ¨¡å‹ï¼‰
          3. åŒå‡»è¿è¡Œ `MEMEFinder.exe`
          
          ### ğŸ“Š ç³»ç»Ÿè¦æ±‚
          
          - Windows 10 64ä½ æˆ–æ›´é«˜
          - 4GB RAMï¼ˆæ¨è 8GB+ï¼‰
          - 3GB ç£ç›˜ç©ºé—´
          
          è¯¦è§ [README.md](https://github.com/aliveriver/MEMEFinder/blob/main/README.md)
    
    - name: ä¸Šä¼ å‘å¸ƒæ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/MEMEFinder-${{ steps.get_version.outputs.VERSION }}-Windows-x64.zip
        asset_name: MEMEFinder-${{ steps.get_version.outputs.VERSION }}-Windows-x64.zip
        asset_content_type: application/zip
