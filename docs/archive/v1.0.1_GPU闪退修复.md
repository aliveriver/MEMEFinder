# v1.0.1 GPU闪退问题修复

## 修复内容

### 问题描述
部分GPU用户在使用打包后的程序时，启动时会卡在"尝试初始化 RapidOCR (GPU 模式)..."阶段，无响应或直接闪退。

### 根本原因
1. **CUDA DLL加载问题**：打包后的onnxruntime-gpu在某些环境下无法正确加载CUDA相关的DLL文件
2. **初始化阻塞**：RapidOCR在尝试初始化CUDA时可能会无限期等待
3. **缺少超时保护**：原代码没有超时机制，导致程序卡死

### 解决方案

#### 1. 添加超时保护机制
- **文件**: `src/core/ocr_processor.py`
- **新增函数**: `_init_rapidocr_with_timeout()`
- **功能**: 使用单独线程初始化RapidOCR，设置30秒超时
- **效果**: GPU初始化超时后自动降级到CPU模式

```python
def _init_rapidocr_with_timeout(kwargs_dict, result_container, timeout=30):
    """在单独线程中初始化RapidOCR，带超时控制"""
    try:
        ocr_instance = RapidOCR(**kwargs_dict)
        result_container['ocr'] = ocr_instance
    except Exception as e:
        result_container['error'] = e
```

#### 2. 增强错误处理
- **超时错误识别**: 专门处理超时错误，给出明确提示
- **自动降级**: GPU模式失败后自动切换到CPU模式
- **详细日志**: 记录完整的错误信息和降级过程

#### 3. 环境变量支持
- **变量名**: `MEMEFINDER_FORCE_CPU`
- **用法**: 设置为 `1`、`true` 或 `yes` 强制使用CPU模式
- **场景**: 用于GPU环境完全不可用的情况

```batch
set MEMEFINDER_FORCE_CPU=1
MEMEFinder.exe
```

#### 4. 用户友好启动脚本
- **文件**: `启动_CPU模式.bat`
- **功能**: 一键启动CPU模式
- **位置**: 打包后的程序根目录

#### 5. 文档完善
- **GPU闪退解决方案.md**: 详细的问题分析和解决方案
- **使用说明.txt**: 更新常见问题，添加GPU闪退说明

## 修改的文件

### 核心代码
1. `src/core/ocr_processor.py`
   - 添加 `_init_rapidocr_with_timeout()` 函数
   - 修改 `__init__()` 方法，添加超时保护
   - 增强错误处理逻辑
   - 添加环境变量检查

### 打包脚本
2. `scripts/build_release.py`
   - 添加 `启动_CPU模式.bat` 生成逻辑
   - 更新使用说明文本

### 文档
3. `docs/GPU闪退解决方案.md` (新增)
   - 问题描述和原因分析
   - 详细解决方案
   - 技术细节说明

4. `启动_CPU模式.bat` (新增)
   - CPU模式快速启动脚本

### 测试
5. `test/test_gpu_timeout.py` (新增)
   - 超时机制测试
   - 环境变量测试
   - 自动检测测试

## 使用方法

### 开发版本测试
```bash
# 测试超时机制
python test/test_gpu_timeout.py

# 强制CPU模式运行
set MEMEFINDER_FORCE_CPU=1
python main.py
```

### 打包发布
```bash
# 重新打包（包含修复）
python scripts/build_release.py
```

### 用户使用
对于遇到GPU闪退的用户：
1. 使用 `启动_CPU模式.bat` 启动程序
2. 或者正常启动，程序会自动降级到CPU模式（30秒超时）

## 测试验证

### 测试环境
- Windows 10/11 x64
- 有GPU的机器（NVIDIA）
- 无GPU的机器

### 测试场景
1. **正常GPU环境**: 应该正常使用GPU模式
2. **GPU环境异常**: 30秒后自动切换CPU模式
3. **无GPU环境**: 自动使用CPU模式
4. **强制CPU**: 环境变量生效，始终使用CPU

### 预期结果
- ✓ 程序不再卡死
- ✓ 自动降级机制工作正常
- ✓ 用户可以手动选择CPU模式
- ✓ 详细的错误提示和解决建议

## 性能影响

### CPU vs GPU 模式
- **速度**: CPU模式约为GPU模式的 1/2 ~ 1/3
- **准确度**: 完全相同
- **稳定性**: CPU模式更稳定，兼容性更好
- **内存**: 差异不大

### 建议
- **小批量处理** (< 1000张): CPU模式足够
- **大批量处理** (> 5000张): GPU模式更快
- **稳定性优先**: 使用CPU模式
- **速度优先**: 尝试GPU模式，失败自动降级

## 后续计划

### v1.0.2 改进
1. GUI中添加CPU/GPU切换选项
2. 启动时快速测试GPU可用性
3. 保存用户选择的模式

### 长期计划
1. 分发两个版本：CPU版（小巧稳定）、GPU版（更快）
2. 智能模式选择算法
3. 支持更多GPU加速方案（DirectML等）

## 相关Issue
- 用户报告：打包后GPU用户闪退
- 日志分析：卡在RapidOCR GPU初始化
- 解决方案：超时保护 + 自动降级

## 测试清单
- [x] 超时机制正常工作
- [x] 自动降级到CPU模式
- [x] 环境变量强制CPU生效
- [x] 启动脚本创建正确
- [x] 文档完整更新
- [ ] 实际打包测试
- [ ] GPU用户验证
- [ ] 无GPU用户验证

---

**更新日期**: 2025-11-15  
**版本**: v1.0.1  
**开发者**: Claude & Team
